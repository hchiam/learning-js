<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>detect-shake.js demo</title>
    <style>
      html,
      body {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      main {
        text-align: center;
      }
      p {
        text-align: center;
        text-wrap: balance;
        font-family: monospace;
      }
      p.on {
        text-align: end;
        font-size: 15dvmin;
      }
      .ten {
        background: yellow;
      }
      .twenty {
        background: green;
      }
      .thirty {
        background: lightblue;
      }
      .shaken {
        outline: solid 1rem lime;
      }
    </style>
  </head>
  <body>
    <main>
      <div>
        <small
          ><span class="ten">&gt;10 = yellow</span>,
          <span class="twenty">&gt;20 = green</span>,
          <span class="thirty">&gt;30 = lightblue</span></small
        >
      </div>
      <p>
        open in mobile and shake to see output -
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/API/DeviceMotionEvent"
          target="_blank"
          >compare Firefox and Chrome</a
        >
      </p>
    </main>
    <script>
      function fmt(value) {
        return (Math.round(value) * 10) / 10;
      }
      let showing = false;
      const threshold = 5;
      detectShake(({ x, y, z, magnitude, shaken }) => {
        const p = document.querySelector("p");
        if (!showing) p.classList.add("on");
        showing = true;
        p.innerText = `${fmt(x)}\n${fmt(y)}\n${fmt(z)}\n${fmt(
          magnitude
        )}\nshaken`;
        p.classList.remove("ten");
        p.classList.remove("twenty");
        p.classList.remove("thirty");
        if (magnitude >= 10 && magnitude < 20) {
          p.classList.add("ten");
        } else if (magnitude >= 20 && magnitude < 30) {
          p.classList.add("twenty");
        } else if (magnitude >= 30) {
          p.classList.add("thirty");
        }
        p.classList.add("shaken");
      }, threshold);
      /** detectShake(({ x, y, z, magnitude }) => {}); */
      function detectShake(callback = () => {}, threshold = 20) {
        let shaken = false;
        let previousVector = { x: 0, y: 0, z: 0 };
        window.addEventListener("devicemotion", (event) => {
          const x = event.accelerationIncludingGravity.x;
          const y = event.accelerationIncludingGravity.y;
          const z = event.accelerationIncludingGravity.z;
          const magnitude = Math.sqrt(x ** 2 + y ** 2 + z ** 2);
          const dotProduct =
            x * previousVector.x + y * previousVector.y + z * previousVector.z;
          if (dotProduct < 0 && magnitude >= threshold) {
            shaken = true;
          }
          if (magnitude >= threshold) {
            previousVector = { x, y, z };
          }
          if (shaken && callback) {
            shaken = false;
            previousVector = { x: 0, y: 0, z: 0 };
            const data = {
              x,
              y,
              z,
              magnitude,
            };
            callback(data);
          }
        });
      }
    </script>
  </body>
</html>
